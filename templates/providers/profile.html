{% extends 'base.html' %}

{% block title %}{{ provider_profile.get_display_name }} - Liberi{% endblock %}
{% block og_title %}{{ provider_name }} | Liberi{% endblock %}
{% block og_description %}{{ meta_description }}{% endblock %}
{% block twitter_title %}{{ provider_name }} | Liberi{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <!-- Hero Section -->
    <div class="provider-hero-section">
        <div class="container">
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb bg-transparent p-0">
                    <li class="breadcrumb-item"><a href="{% url 'home' %}" class="text-white"
                            style="opacity: 0.8;">Inicio</a></li>
                    <li class="breadcrumb-item active text-white" aria-current="page">{{ provider_name }}</li>
                </ol>
            </nav>

            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="d-flex align-items-start gap-4 flex-wrap">
                        <!-- Avatar -->
                        <div class="flex-shrink-0">
                            {% if provider_profile.profile_photo %}
                            <img src="{{ provider_profile.profile_photo.url }}"
                                alt="{{ provider_profile.get_display_name }}" class="provider-avatar">
                            {% else %}
                            <div class="provider-avatar-placeholder">
                                <i class="fas fa-user"></i>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Info -->
                        <div class="flex-grow-1">
                            {% if provider_profile.business_name %}
                            <h1 class="mb-2 text-white" style="font-size: 2.5rem; font-weight: 700;">
                                {{provider_profile.business_name }}</h1>
                            <p class="mb-2 text-white" style="font-size: 1.1rem; opacity: 0.9;">{{ provider.get_full_name }}</p>
                            {% else %}
                            <h1 class="mb-2 text-white" style="font-size: 2.5rem; font-weight: 700;">{{ provider.get_full_name }}</h1>
                            {% endif %}

                            <p class="mb-3 text-white" style="font-size: 1.1rem; opacity: 0.95;">
                                {{ provider_profile.category.icon }} {{ provider_profile.category.name }}
                            </p>

                            {% if provider_profile.status == 'approved' %}
                            <div class="verified-badge">
                                <i class="fas fa-check-circle"></i>
                                <span>Proveedor Verificado</span>
                            </div>
                            {% endif %}

                            <!-- Service Mode -->
                            {% if provider_profile.service_mode %}
                            <div class="mode-badge">
                                {% if provider_profile.service_mode == 'home' %}
                                <i class="fas fa-car"></i> Atiende a domicilio
                                {% elif provider_profile.service_mode == 'local' %}
                                <i class="fas fa-store"></i> Atiende en local
                                {% else %}
                                <i class="fas fa-arrows-alt"></i> Ambas modalidades
                                {% endif %}
                            </div>
                            {% endif %}

                            <!-- Hero Stats -->
                            <div class="hero-stats">
                                <div class="hero-stat">
                                    <i class="fas fa-star"></i>
                                    <strong>{{ rating_avg }}</strong> ({{ total_reviews }} reseñas)
                                </div>
                                <div class="hero-stat">
                                    <i class="fas fa-briefcase"></i>
                                    <strong>{{ completed_bookings }}</strong> trabajos completados
                                </div>
                                <div class="hero-stat">
                                    <i class="fas fa-calendar-alt"></i>
                                    <strong>{{ years_display }}</strong> en Liberi
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4 text-md-end mt-4 mt-md-0">
                    <a href="{% url 'services_list' %}?provider={{ provider.id }}" class="cta-primary">
                        <i class="fas fa-calendar-check me-2"></i>Reservar Servicio
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-4 mb-5">
        <div class="row">
            <!-- Main Content -->
            <div class="col-lg-8">
                <!-- Trust Signals -->
                <div class="trust-bar fade-in-up">
                    <div class="trust-indicators">
                        <div class="trust-item">
                            <i class="fas fa-shield-alt"></i>
                            <div>
                                <strong>100% Verificado</strong>
                                <div style="font-size: 0.85rem; color: #6b7280;">Identidad confirmada</div>
                            </div>
                        </div>
                        <div class="trust-item">
                            <i class="fas fa-lock"></i>
                            <div>
                                <strong>Pagos Seguros</strong>
                                <div style="font-size: 0.85rem; color: #6b7280;">Transacciones protegidas</div>
                            </div>
                        </div>
                        <div class="trust-item">
                            <i class="fas fa-star"></i>
                            <div>
                                <strong>Calidad Garantizada</strong>
                                <div style="font-size: 0.85rem; color: #6b7280;">Satisfacción asegurada</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- About Section -->
                <div class="about-section fade-in-up">
                    <h4><i class="fas fa-info-circle"></i> Conoce a tu profesional</h4>
                    <p>{{ provider_profile.description }}</p>
                </div>

                <!-- Metrics -->
                <div class="metrics-grid fade-in-up">
                    <div class="metric-card">
                        <i class="fas fa-star stat-icon"></i>
                        <span class="metric-value">{{ rating_avg }}</span>
                        <div class="metric-label">Rating Promedio</div>
                    </div>
                    <div class="metric-card">
                        <i class="fas fa-check-circle stat-icon"></i>
                        <span class="metric-value">{{ completed_bookings }}</span>
                        <div class="metric-label">Trabajos Hechos</div>
                    </div>
                    <div class="metric-card">
                        <i class="fas fa-comments stat-icon"></i>
                        <span class="metric-value">{{ total_reviews }}</span>
                        <div class="metric-label">Reseñas</div>
                    </div>
                    <div class="metric-card">
                        <i class="fas fa-concierge-bell stat-icon"></i>
                        <span class="metric-value">{{ services|length }}</span>
                        <div class="metric-label">Servicios</div>
                    </div>
                </div>

                <!-- Services Section -->
                <div class="card border-0 shadow-sm mb-4 fade-in-up" style="border-radius: 20px;">
                    <div class="card-body p-4">
                        <h4 class="mb-4" style="font-weight: 700; color: #1f2937;">
                            <i class="fas fa-concierge-bell me-2 text-primary"></i>
                            Servicios Ofrecidos
                        </h4>

                        {% if services %}
                        <div class="row g-4">
                            {% for service in services %}
                            <div class="col-md-6">
                                <div class="provider-service-card">
                                    <div class="service-image-wrapper">
                                        {% if service.primary_image %}
                                        <img src="{{ service.primary_image.url }}" alt="{{ service.name }}">
                                        {% else %}
                                        <div
                                            style="width: 100%; height: 100%; background: linear-gradient(135deg, #e5e7eb 0%, #9ca3af 100%); display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-image fa-3x text-secondary"></i>
                                        </div>
                                        {% endif %}
                                        <div class="service-image-overlay"></div>
                                        <div class="service-price-badge">${{ service.base_price }}</div>
                                    </div>

                                    <div class="service-card-body">
                                        <h5>{{ service.name }}</h5>
                                        <p class="service-description">{{ service.description|striptags|truncatewords:18}}</p>

                                        <div class="service-meta">
                                            <span class="service-duration">
                                                <i class="far fa-clock me-1"></i>{{ service.duration_minutes }} min
                                            </span>
                                        </div>

                                        <a href="{% url 'service_detail' service.service_code %}" class="service-cta">
                                            Ver Detalles <i class="fas fa-arrow-right ms-1"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="alert alert-info border-0">
                            <i class="fas fa-info-circle me-2"></i>
                            Este proveedor aún no ha agregado servicios
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Reviews Section -->
                {% if reviews %}
                <div class="card border-0 shadow-sm fade-in-up" style="border-radius: 20px;">
                    <div class="card-body p-4">
                        <h4 class="mb-4" style="font-weight: 700; color: #1f2937;">
                            <i class="fas fa-star me-2" style="color: #fbbf24;"></i>
                            Reseñas de Clientes
                        </h4>

                        <!-- Review Summary -->
                        <div class="review-header">
                            <div class="review-summary">
                                <div>
                                    <div class="rating-big">{{ rating_avg }}</div>
                                    <div class="stars-big mb-2">
                                        {% for i in "12345" %}
                                        {% if forloop.counter <= rating_avg %} <i class="fas fa-star"></i>
                                            {% else %}
                                            <i class="far fa-star"></i>
                                            {% endif %}
                                            {% endfor %}
                                    </div>
                                    <div style="color: #6b7280;">{{ total_reviews }} reseña{{ total_reviews|pluralize }}
                                    </div>
                                </div>

                                <div class="rating-breakdown">
                                    <div class="breakdown-row">
                                        <span style="min-width: 60px; font-size: 0.9rem;">5 estrellas</span>
                                        <div class="breakdown-bar">
                                            {% if total_reviews > 0 %}
                                            {% widthratio rating_distribution.5 total_reviews 100 as percentage %}
                                            <div class="breakdown-fill" style="width: {{ percentage|default:0 }}%">
                                            </div>
                                            {% else %}
                                            <div class="breakdown-fill" style="width: 0%"></div>
                                            {% endif %}
                                        </div>
                                        <span
                                            style="min-width: 40px; text-align: right; font-size: 0.85rem; color: #6b7280;">
                                            {{ rating_distribution.5|default:0 }}
                                        </span>
                                    </div>
                                    <div class="breakdown-row">
                                        <span style="min-width: 60px; font-size: 0.9rem;">4 estrellas</span>
                                        <div class="breakdown-bar">
                                            {% if total_reviews > 0 %}
                                            {% widthratio rating_distribution.4 total_reviews 100 as percentage %}
                                            <div class="breakdown-fill" style="width: {{ percentage|default:0 }}%">
                                            </div>
                                            {% else %}
                                            <div class="breakdown-fill" style="width: 0%"></div>
                                            {% endif %}
                                        </div>
                                        <span
                                            style="min-width: 40px; text-align: right; font-size: 0.85rem; color: #6b7280;">
                                            {{ rating_distribution.4|default:0 }}
                                        </span>
                                    </div>
                                    <div class="breakdown-row">
                                        <span style="min-width: 60px; font-size: 0.9rem;">3 estrellas</span>
                                        <div class="breakdown-bar">
                                            {% if total_reviews > 0 %}
                                            {% widthratio rating_distribution.3 total_reviews 100 as percentage %}
                                            <div class="breakdown-fill" style="width: {{ percentage|default:0 }}%">
                                            </div>
                                            {% else %}
                                            <div class="breakdown-fill" style="width: 0%"></div>
                                            {% endif %}
                                        </div>
                                        <span
                                            style="min-width: 40px; text-align: right; font-size: 0.85rem; color: #6b7280;">
                                            {{ rating_distribution.3|default:0 }}
                                        </span>
                                    </div>
                                    <div class="breakdown-row">
                                        <span style="min-width: 60px; font-size: 0.9rem;">2 estrellas</span>
                                        <div class="breakdown-bar">
                                            {% if total_reviews > 0 %}
                                            {% widthratio rating_distribution.2 total_reviews 100 as percentage %}
                                            <div class="breakdown-fill" style="width: {{ percentage|default:0 }}%">
                                            </div>
                                            {% else %}
                                            <div class="breakdown-fill" style="width: 0%"></div>
                                            {% endif %}
                                        </div>
                                        <span
                                            style="min-width: 40px; text-align: right; font-size: 0.85rem; color: #6b7280;">
                                            {{ rating_distribution.2|default:0 }}
                                        </span>
                                    </div>
                                    <div class="breakdown-row">
                                        <span style="min-width: 60px; font-size: 0.9rem;">1 estrella</span>
                                        <div class="breakdown-bar">
                                            {% if total_reviews > 0 %}
                                            {% widthratio rating_distribution.1 total_reviews 100 as percentage %}
                                            <div class="breakdown-fill" style="width: {{ percentage|default:0 }}%">
                                            </div>
                                            {% else %}
                                            <div class="breakdown-fill" style="width: 0%"></div>
                                            {% endif %}
                                        </div>
                                        <span
                                            style="min-width: 40px; text-align: right; font-size: 0.85rem; color: #6b7280;">
                                            {{ rating_distribution.1|default:0 }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Top Reviews -->
                        {% if top_reviews %}
                        <h5 class="mb-3" style="font-weight: 600; color: #1f2937;">⭐ Reseñas Destacadas</h5>
                        {% for review in top_reviews %}
                        <div class="review-card top-review">
                            <div class="review-header-row">
                                <div class="reviewer-info">
                                    <div class="reviewer-avatar">
                                        {{ review.customer.first_name.0|upper }}{{ review.customer.last_name.0|upper }}
                                    </div>
                                    <div>
                                        <strong>{{ review.customer.get_full_name }}</strong>
                                        <div class="stars-review mt-1">
                                            {% for i in "12345" %}
                                            {% if forloop.counter <= review.rating %} <i class="fas fa-star"></i>
                                                {% else %}
                                                <i class="far fa-star"></i>
                                                {% endif %}
                                                {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                <small class="review-date">{{ review.created_at|date:"d/m/Y" }}</small>
                            </div>
                            {% if review.comment %}
                            <p class="mb-0" style="color: #4b5563;">{{ review.comment }}</p>
                            {% endif %}
                        </div>
                        {% endfor %}
                        {% endif %}

                        <!-- All Reviews -->
                        {% if reviews|length > 3 %}
                        <h5 class="mt-4 mb-3" style="font-weight: 600; color: #1f2937;">Todas las Reseñas</h5>
                        {% endif %}
                        {% for review in reviews %}
                        {% if not review in top_reviews %}
                        <div class="review-card">
                            <div class="review-header-row">
                                <div class="reviewer-info">
                                    <div class="reviewer-avatar">
                                        {{ review.customer.first_name.0|upper }}{{ review.customer.last_name.0|upper }}
                                    </div>
                                    <div>
                                        <strong>{{ review.customer.get_full_name }}</strong>
                                        <div class="stars-review mt-1">
                                            {% for i in "12345" %}
                                            {% if forloop.counter <= review.rating %} <i class="fas fa-star"></i>
                                                {% else %}
                                                <i class="far fa-star"></i>
                                                {% endif %}
                                                {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                <small class="review-date">{{ review.created_at|date:"d/m/Y" }}</small>
                            </div>
                            {% if review.comment %}
                            <p class="mb-0" style="color: #4b5563;">{{ review.comment }}</p>
                            {% endif %}
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4 mt-4 mt-lg-0">
                <div class="sidebar-sticky">
                    <!-- Contact Card -->
                    <div class="contact-card">
                        <h5><i class="fas fa-calendar-check me-2"></i>¿Listo para reservar?</h5>
                        <a href="{% url 'services_list' %}?provider={{ provider.id }}" class="cta-secondary mb-2">
                            <i class="fas fa-concierge-bell me-2"></i>Ver Todos los Servicios
                        </a>
                        <div class="text-center mt-3" style="font-size: 0.9rem; opacity: 0.9;">
                            <i class="fas fa-bolt me-1"></i>Respuesta rápida garantizada
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <span class="stat-value">{{ rating_avg }}</span>
                        <div class="stat-label">Calificación Promedio</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <span class="stat-value">{{ completed_bookings }}</span>
                        <div class="stat-label">Trabajos Completados</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-concierge-bell"></i>
                        </div>
                        <span class="stat-value">{{ services|length }}</span>
                        <div class="stat-label">Servicio{{ services|length|pluralize }}</div>
                    </div>

                    <!-- Coverage Info -->
                    {% if provider_profile.coverage_zones.all %}
                    <div class="card border-0 shadow-sm" style="border-radius: 15px;">
                        <div class="card-body">
                            <h6 style="font-weight: 700; color: #1f2937; margin-bottom: 1rem;">
                                <i class="fas fa-map-marker-alt me-2 text-primary"></i>
                                Zonas de Cobertura
                            </h6>
                            <div class="d-flex flex-wrap gap-2">
                                {% for zone in provider_profile.coverage_zones.all %}
                                <span class="badge bg-light text-primary"
                                    style="padding: 0.5rem 0.75rem; border-radius: 50px; font-weight: 600;">
                                    {{ zone.name }}
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Guarantee Badges -->
                    <div class="card border-0 shadow-sm mt-3" style="border-radius: 15px;">
                        <div class="card-body">
                            <div class="guarantee-badges">
                                <div class="guarantee-badge">
                                    <i class="fas fa-shield-alt"></i>
                                    <span>100% Verificado</span>
                                </div>
                                <div class="guarantee-badge">
                                    <i class="fas fa-thumbs-up"></i>
                                    <span>Satisfacción Garantizada</span>
                                </div>
                                <div class="guarantee-badge">
                                    <i class="fas fa-bolt"></i>
                                    <span>Respuesta Rápida</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Animación de fade-in al scroll
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    }, observerOptions);

    document.querySelectorAll('.fade-in-up').forEach(el => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(30px)';
        el.style.transition = 'opacity 0.6s ease-out, transform 0.6s ease-out';
        observer.observe(el);
    });
</script>
{% endblock %}