{% extends "base.html" %}
{% load static %}

{% block title %}Modalidad de Atención - Liberi{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <!-- Breadcrumbs -->
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'provider_locations_list' %}">Mis Ubicaciones</a></li>
                    <li class="breadcrumb-item active">Modalidad de Atención</li>
                </ol>
            </nav>

            <!-- Header -->
            <div class="mb-5">
                <h1 class="h2 mb-2"><i class="fas fa-cogs"></i> Modalidad de Atención</h1>
                <p class="text-muted">¿Cómo quieres atender a tus clientes?</p>
            </div>

            <!-- Formulario -->
            <form method="post" id="serviceModeForm">
                {% csrf_token %}

                <!-- Alertas de ubicaciones existentes -->
                {% if has_base or has_locals %}
                <div class="alert alert-warning mb-4">
                    <h6 class="mb-2"><i class="fas fa-exclamation-triangle"></i> Ubicaciones Registradas</h6>
                    <p class="mb-2">Actualmente tienes:</p>
                    <ul class="mb-2">
                        {% if has_base %}
                        <li><strong>Domicilio Base</strong> registrado</li>
                        {% endif %}
                        {% if has_locals %}
                        <li><strong>Local(es)</strong> registrado(s)</li>
                        {% endif %}
                    </ul>
                    <p class="mb-0 small">
                        <strong>Nota:</strong> Si seleccionas una modalidad incompatible con tus ubicaciones actuales, 
                        deberás eliminar las ubicaciones que no correspondan antes de cambiar.
                    </p>
                </div>
                {% endif %}

                <!-- Opciones -->
                <div class="row g-3 mb-5">
                    <!-- Opción 1: Solo a Domicilio -->
                    <div class="col-md-6">
                        <div class="card option-card cursor-pointer h-100" data-mode="home">
                            <div class="card-body text-center py-4">
                                <div class="mb-3">
                                    <i class="fas fa-car fa-3x text-success"></i>
                                </div>
                                <h5 class="card-title">Solo a Domicilio</h5>
                                <p class="card-text text-muted small">
                                    Atiendes en casa del cliente
                                </p>
                                <hr>
                                <div class="requirements text-start small">
                                    <p><i class="fas fa-check-circle text-success"></i> Necesitas: Domicilio Base</p>
                                    <p><i class="fas fa-times-circle text-danger"></i> No necesitas: Locales</p>
                                    <p><i class="fas fa-check-circle text-success"></i> Se aplica: Costo de traslado</p>
                                </div>
                                <div class="mt-3">
                                    <input type="radio" name="service_mode" value="home" id="mode_home"
                                        class="form-check-input" style="display:none;">
                                    <span class="mode-indicator d-none">
                                        <i class="fas fa-check-circle text-success"></i> Seleccionado
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Opción 2: Solo en Local -->
                    <div class="col-md-6">
                        <div class="card option-card cursor-pointer h-100" data-mode="local">
                            <div class="card-body text-center py-4">
                                <div class="mb-3">
                                    <i class="fas fa-store fa-3x text-info"></i>
                                </div>
                                <h5 class="card-title">Solo en Local</h5>
                                <p class="card-text text-muted small">
                                    Clientes vienen a tu local
                                </p>
                                <hr>
                                <div class="requirements text-start small">
                                    <p><i class="fas fa-times-circle text-danger"></i> No necesitas: Domicilio Base</p>
                                    <p><i class="fas fa-check-circle text-success"></i> Necesitas: Locales verificados
                                    </p>
                                    <p><i class="fas fa-times-circle text-danger"></i> No aplica: Costo de traslado</p>
                                </div>
                                <div class="mt-3">
                                    <input type="radio" name="service_mode" value="local" id="mode_local"
                                        class="form-check-input" style="display:none;">
                                    <span class="mode-indicator d-none">
                                        <i class="fas fa-check-circle text-success"></i> Seleccionado
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Opción 3: Ambos -->
                    <div class="col-md-12">
                        <div class="card option-card cursor-pointer" data-mode="both">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <i class="fas fa-arrows-alt fa-3x text-warning"></i>
                                    </div>
                                    <div class="col">
                                        <h5 class="mb-1">Local y Domicilio</h5>
                                        <p class="text-muted mb-0">Clientes eligen dónde quieren ser atendidos</p>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <div class="requirements text-start small">
                                            <p class="mb-1"><i class="fas fa-check-circle text-success"></i> Necesitas:
                                                Domicilio Base</p>
                                            <p class="mb-1"><i class="fas fa-check-circle text-success"></i> Necesitas:
                                                Locales verificados</p>
                                            <p class="mb-0"><i class="fas fa-check-circle text-success"></i> Se aplica:
                                                Costo traslado (domicilio)</p>
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <input type="radio" name="service_mode" value="both" id="mode_both"
                                            class="form-check-input" style="display:none;">
                                        <span class="mode-indicator d-none">
                                            <i class="fas fa-check-circle text-success fa-2x"></i> Seleccionado
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Info Dinámica -->
                <div class="card bg-light mb-4">
                    <div class="card-body">
                        <h6 class="mb-3">Requisitos para Publicar Servicios</h6>
                        <div id="requirements-info" class="small">
                            <p class="text-muted">Selecciona una opción arriba para ver los requisitos</p>
                        </div>
                    </div>
                </div>

                <!-- Botones -->
                <div class="d-flex gap-2 mb-4">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-save"></i> Guardar Modalidad
                    </button>
                    <a href="{% url 'provider_locations_list' %}" class="btn btn-secondary btn-lg">
                        <i class="fas fa-times"></i> Cancelar
                    </a>
                </div>

                <!-- Consejos -->
                <div class="alert alert-info">
                    <h6 class="mb-2"><i class="fas fa-lightbulb"></i> Consejos</h6>
                    <ul class="mb-0 small">
                        <li><strong>Domicilio:</strong> Ideal si tienes movilidad propia y quieres llegar a más clientes
                        </li>
                        <li><strong>Local:</strong> Mejor si tienes un local fijo y esperas que clientes vayan allá</li>
                        <li><strong>Ambos:</strong> La opción más flexible - ofrece lo mejor de ambos mundos</li>
                        <li>Puedes cambiar esto en cualquier momento desde Mis Ubicaciones</li>
                    </ul>
                </div>

            </form>

        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const cards = document.querySelectorAll('.option-card');
        const form = document.getElementById('serviceModeForm');

        // Variables de ubicaciones existentes
        const hasBase = {{ has_base|yesno:"true,false" }};
        const hasLocals = {{ has_locals|yesno:"true,false" }};

        // Cargar modo guardado
        const savedMode = '{{ form.instance.service_mode }}';
        if (savedMode) {
            selectMode(savedMode);
        }

        // Deshabilitar opciones incompatibles
        if (hasLocals && !hasBase) {
            // Tiene locales pero no domicilio base → deshabilitar "Solo a Domicilio"
            disableCard('home', 'No puedes seleccionar esta opción porque tienes locales registrados. Elimínalos primero.');
        }
        
        if (hasBase && !hasLocals) {
            // Tiene domicilio base pero no locales → deshabilitar "Solo en Local"
            disableCard('local', 'No puedes seleccionar esta opción porque tienes domicilio base registrado. Elimínalo primero.');
        }

        // Click en cards
        cards.forEach(card => {
            card.addEventListener('click', function () {
                if (this.classList.contains('disabled-card')) {
                    return; // No hacer nada si está deshabilitada
                }
                const mode = this.dataset.mode;
                selectMode(mode);
            });
        });

        function disableCard(mode, reason) {
            const card = document.querySelector(`[data-mode="${mode}"]`);
            if (card) {
                card.classList.add('disabled-card');
                card.style.opacity = '0.5';
                card.style.cursor = 'not-allowed';
                
                // Agregar mensaje de error
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger mt-2 mb-0 small';
                errorDiv.innerHTML = '<i class="fas fa-ban"></i> ' + reason;
                card.querySelector('.card-body').appendChild(errorDiv);
                
                // Deshabilitar radio
                const radio = card.querySelector('input[type="radio"]');
                if (radio) {
                    radio.disabled = true;
                }
            }
        }

        function selectMode(mode) {
            // Deseleccionar todos
            cards.forEach(card => {
                if (!card.classList.contains('disabled-card')) {
                    card.classList.remove('border-success', 'border-2');
                    card.querySelector('.mode-indicator').classList.add('d-none');
                }
            });

            // Seleccionar el elegido
            const selectedCard = document.querySelector(`[data-mode="${mode}"]`);
            if (selectedCard && !selectedCard.classList.contains('disabled-card')) {
                selectedCard.classList.add('border-success', 'border-2');
                selectedCard.querySelector('.mode-indicator').classList.remove('d-none');
                selectedCard.style.backgroundColor = 'rgba(40, 167, 69, 0.05)';

                // Seleccionar radio
                document.getElementById(`mode_${mode}`).checked = true;

                // Actualizar requisitos
                updateRequirements(mode);
            }
        }

        function updateRequirements(mode) {
            const infoDiv = document.getElementById('requirements-info');
            let html = '';

            if (mode === 'home') {
                html = `
                <div class="mb-2">
                    <h6 class="mb-2"><i class="fas fa-check-circle text-success"></i> Necesitas:</h6>
                    <ul class="mb-3">
                        <li><strong>Domicilio Base:</strong> Es obligatorio para publicar servicios</li>
                    </ul>
                </div>
                <div class="mb-2">
                    <h6 class="mb-2"><i class="fas fa-times-circle text-danger"></i> No Necesitas:</h6>
                    <ul>
                        <li>Locales / Sucursales</li>
                    </ul>
                </div>
                <p class="mt-3 mb-0"><i class="fas fa-info-circle"></i> Se aplicará costo de traslado en todas las reservas</p>
            `;
            } else if (mode === 'local') {
                html = `
                <div class="mb-2">
                    <h6 class="mb-2"><i class="fas fa-check-circle text-success"></i> Necesitas:</h6>
                    <ul class="mb-3">
                        <li><strong>Al menos 1 Local Verificado:</strong> Para que aparezcan tus servicios</li>
                    </ul>
                </div>
                <div class="mb-2">
                    <h6 class="mb-2"><i class="fas fa-times-circle text-danger"></i> No Necesitas:</h6>
                    <ul>
                        <li>Domicilio Base</li>
                    </ul>
                </div>
                <p class="mt-3 mb-0"><i class="fas fa-info-circle"></i> Los clientes irán a tu local, no hay costo de traslado</p>
            `;
            } else if (mode === 'both') {
                html = `
                <div class="mb-2">
                    <h6 class="mb-2"><i class="fas fa-check-circle text-success"></i> Necesitas:</h6>
                    <ul class="mb-3">
                        <li><strong>Domicilio Base:</strong> Para atender a domicilio</li>
                        <li><strong>Al menos 1 Local Verificado:</strong> Para atender en local</li>
                    </ul>
                </div>
                <p class="mt-3 mb-0"><i class="fas fa-info-circle"></i> Clientes podrán elegir. Costo de traslado solo aplica para domicilio</p>
            `;
            }

            infoDiv.innerHTML = html;
        }
    });
</script>

<style>
    .option-card {
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid #ddd;
    }

    .option-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border-color: #0d6efd;
    }

    .option-card.border-success {
        border-color: #28a745 !important;
        background-color: rgba(40, 167, 69, 0.05);
    }

    .option-card.disabled-card {
        opacity: 0.5;
        cursor: not-allowed !important;
        pointer-events: all;
    }

    .option-card.disabled-card:hover {
        box-shadow: none;
        border-color: #ddd;
    }

    .mode-indicator {
        display: inline-block;
    }

    .cursor-pointer {
        cursor: pointer;
    }

    .requirements {
        border-top: 1px solid rgba(0, 0, 0, 0.1);
        padding-top: 0.75rem;
    }

    .requirements p {
        margin: 0.25rem 0;
    }
</style>
{% endblock %}