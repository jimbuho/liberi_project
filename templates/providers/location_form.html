{% extends "base.html" %}
{% load static %}

{% block title %}
{% if form.instance.pk %}
Editar Ubicaci√≥n - Liberi
{% else %}
Nueva Ubicaci√≥n - Liberi
{% endif %}
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <!-- Breadcrumbs -->
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'provider_locations_list' %}">Mis Ubicaciones</a></li>
                    <li class="breadcrumb-item active">
                        {% if form.instance.pk %}
                        Editar
                        {% else %}
                        Nueva
                        {% endif %}
                    </li>
                </ol>
            </nav>

            <!-- Header -->
            <div class="mb-4">
                {% if form.instance.pk %}
                <h1 class="h2"><i class="fas fa-edit"></i> Editar Ubicaci√≥n</h1>
                {% else %}
                <h1 class="h2"><i class="fas fa-plus-circle"></i> Nueva Ubicaci√≥n</h1>
                {% endif %}
            </div>

            <!-- Formulario -->
            <form method="post" class="needs-validation" novalidate>
                {% csrf_token %}

                <!-- Tipo de Ubicaci√≥n -->
                {% if location_type %}
                <div class="card mb-4">
                    <div class="card-body">
                        <h6 class="mb-3">Tipo de Ubicaci√≥n</h6>
                        <div class="alert alert-info">
                            {% if location_type == 'base' %}
                            <i class="fas fa-home"></i> <strong>Domicilio Base</strong> - Tu domicilio principal
                            {% else %}
                            <i class="fas fa-store"></i> <strong>Local / Sucursal</strong> - Otro lugar de atenci√≥n
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="card mb-4">
                    <div class="card-body">
                        <h6 class="mb-3">Tipo de Ubicaci√≥n</h6>
                        <div class="mb-3">
                            {% for value, label in form.location_type.field.choices %}
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="location_type"
                                    id="id_location_type_{{ value }}" value="{{ value }}" {% if form.location_type.value == value %}checked{% endif %}>
                                <label class="form-check-label" for="id_location_type_{{ value }}">
                                    {% if value == 'base' %}
                                    <i class="fas fa-home"></i> Domicilio Base
                                    {% else %}
                                    <i class="fas fa-store"></i> Local / Sucursal
                                    {% endif %}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Ciudad y Zona -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="{{ form.city.id_for_label }}" class="form-label">
                                    {{ form.city.label }}
                                </label>
                                {{ form.city }}
                                {% if form.city.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.city.errors }}
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.zone.id_for_label }}" class="form-label">
                                    {{ form.zone.label }}
                                </label>
                                {{ form.zone }}
                                {% if form.zone.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.zone.errors }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Nombre e Informaci√≥n -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="{{ form.label.id_for_label }}" class="form-label">
                                {{ form.label.label }}
                            </label>
                            {{ form.label }}
                            {% if form.label.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.label.errors }}
                            </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.address.id_for_label }}" class="form-label">
                                {{ form.address.label }}
                            </label>
                            {{ form.address }}
                            {% if form.address.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.address.errors }}
                            </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.reference.id_for_label }}" class="form-label">
                                {{ form.reference.label }}
                            </label>
                            {{ form.reference }}
                            <small class="text-muted">Ej: Frente a farmacia, Piso 2</small>
                            {% if form.reference.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.reference.errors }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Mapa Interactivo -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-map"></i> Ubicaci√≥n en Mapa</h6>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">Haz click en el mapa para marcar la ubicaci√≥n exacta</p>
                        <div id="map" style="height: 400px; border-radius: 5px;" class="mb-3"></div>

                        <div class="row">
                            <div class="col-md-6">
                                <label for="{{ form.latitude.id_for_label }}" class="form-label">
                                    {{ form.latitude.label }}
                                </label>
                                {{ form.latitude }}
                                {% if form.latitude.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.latitude.errors }}
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.longitude.id_for_label }}" class="form-label">
                                    {{ form.longitude.label }}
                                </label>
                                {{ form.longitude }}
                                {% if form.longitude.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.longitude.errors }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- WhatsApp -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="mb-0">
                            <label for="{{ form.whatsapp_number.id_for_label }}" class="form-label">
                                {{ form.whatsapp_number.label }}
                            </label>
                            {{ form.whatsapp_number }}
                            <small class="text-muted">Dejalo vac√≠o para usar el n√∫mero principal</small>
                            {% if form.whatsapp_number.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.whatsapp_number.errors }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Informaci√≥n seg√∫n tipo -->
                <div class="card bg-light mb-4">
                    <div class="card-body">
                        <h6 class="mb-3"><i class="fas fa-info-circle"></i> Informaci√≥n</h6>
                        {% if location_type == 'base' or form.instance.location_type == 'base' %}
                        <ul class="mb-0 small">
                            <li>Se auto-verifica autom√°ticamente</li>
                            <li>Solo puedes tener 1 domicilio base</li>
                            <li>Los clientes lo ven en tu perfil</li>
                        </ul>
                        {% else %}
                        <ul class="mb-0 small">
                            <li>Requiere verificaci√≥n manual del equipo Liberi</li>
                            <li>Puedes tener m√∫ltiples locales</li>
                            <li>Solo se mostrar√° cuando est√© verificada</li>
                        </ul>
                        {% endif %}
                    </div>
                </div>

                <!-- Botones -->
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        {% if form.instance.pk %}
                        Guardar Cambios
                        {% else %}
                        Crear Ubicaci√≥n
                        {% endif %}
                    </button>
                    <a href="{% url 'provider_locations_list' %}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancelar
                    </a>
                </div>

            </form>

        </div>
    </div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Inicializar mapa
        const map = L.map('map').setView([-0.2298, -78.5249], 13); // Quito center
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        let marker = null;

        // Cargar coordenadas existentes
        const latInput = document.getElementById('{{ form.latitude.id_for_label }}');
        const lngInput = document.getElementById('{{ form.longitude.id_for_label }}');

        if (latInput.value && lngInput.value) {
            const lat = parseFloat(latInput.value);
            const lng = parseFloat(lngInput.value);
            marker = L.marker([lat, lng]).addTo(map);
            map.setView([lat, lng], 15);
        }

        // Click en mapa para marcar ubicaci√≥n
        map.on('click', function (e) {
            if (marker) {
                map.removeLayer(marker);
            }
            const { lat, lng } = e.latlng;
            marker = L.marker([lat, lng]).addTo(map);

            latInput.value = lat.toFixed(6);
            lngInput.value = lng.toFixed(6);

            console.log('üìç Ubicaci√≥n marcada:', lat.toFixed(6), lng.toFixed(6));
        });

        // AJAX: Cargar zonas cuando cambia ciudad
        const citySelect = document.getElementById('id_city');
        if (citySelect) {
            citySelect.addEventListener('change', function () {
                const cityId = this.value;
                const zoneSelect = document.getElementById('id_zone');

                if (!cityId) {
                    zoneSelect.innerHTML = '<option value="">Selecciona zona...</option>';
                    return;
                }

                fetch('{% url "api_get_zones_by_city" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: 'city_id=' + cityId
                })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            zoneSelect.innerHTML = '<option value="">Selecciona zona...</option>';
                            data.zones.forEach(zone => {
                                const opt = document.createElement('option');
                                opt.value = zone.id;
                                opt.textContent = zone.name;
                                zoneSelect.appendChild(opt);
                            });
                        }
                    })
                    .catch(err => console.error('Error:', err));
            });
        }

        // ‚úÖ VALIDACI√ìN CORREGIDA
        const form = document.querySelector('.needs-validation');
        if (form) {
            form.addEventListener('submit', function (event) {
                // Validar coordenadas manualmente
                if (!latInput.value || !lngInput.value) {
                    event.preventDefault();
                    event.stopPropagation();
                    alert('Por favor, selecciona una ubicaci√≥n en el mapa');
                    form.classList.add('was-validated');
                    return false;
                }

                // Validar HTML5
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                    form.classList.add('was-validated');
                    return false;
                }

                // Si todo est√° bien, permitir submit
                return true;
            });
        }
    });
</script>

<style>
    .form-select,
    .form-control {
        border: 1px solid #ddd;
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
</style>
{% endblock %}