<!-- templates/locations/create.html -->
{% extends 'base.html' %}

{% block title %}Agregar Ubicación - Liberi{% endblock %}

{% block content %}
<div class="container mt-4 mb-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="fas fa-map-marked-alt"></i> Agregar Nueva Ubicación
                </h2>
                <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Atrás
                </a>
            </div>

            <div class="card">
                <div class="card-body">
                    <form method="post" id="locationForm">
                        {% csrf_token %}

                        <!-- NUEVA: Selección de Ciudad -->
                        <div class="mb-3">
                            <label for="city" class="form-label fw-bold">
                                <i class="fas fa-city"></i> Ciudad
                            </label>
                            <p class="text-muted small mb-2">
                                {% if current_city %}
                                    Estás agregando ubicación en <strong>{{ current_city.name }}</strong>
                                {% else %}
                                    Selecciona la ciudad donde deseas agregar la ubicación
                                {% endif %}
                            </p>
                            {% if current_city %}
                                <input type="hidden" name="city" value="{{ current_city.id }}">
                                <input type="text" class="form-control" value="{{ current_city.name }}" readonly>
                            {% endif %}
                        </div>

                        <!-- Selección de Zona -->
                        <div class="mb-3">
                            <label for="zone" class="form-label fw-bold">
                                <i class="fas fa-map-marked-alt"></i> Zona de Cobertura
                            </label>
                            <select name="zone" id="zone" class="form-select" required>
                                <option value="">-- Selecciona una zona --</option>
                                {% for zone in zones %}
                                <option value="{{ zone.id }}">
                                    {{ zone.name }}
                                </option>
                                {% endfor %}
                            </select>
                            {% if not zones %}
                            <div class="alert alert-warning mt-2">
                                <i class="fas fa-exclamation-triangle"></i>
                                No hay zonas disponibles en {{ current_city.name }}
                            </div>
                            {% endif %}
                            <small class="text-muted d-block mt-1">
                                La zona debe estar dentro de tu ciudad
                            </small>
                        </div>

                        <!-- NUEVO: Quién recibe el servicio -->
                        <div class="mb-3">
                            <label for="recipient_name" class="form-label fw-bold">
                                <i class="fas fa-user"></i> ¿Quién recibe el servicio? (Opcional)
                            </label>
                            <input type="text" name="recipient_name" id="recipient_name" class="form-control" 
                                   placeholder="Ej: María Pérez, Juan García...">
                            <small class="text-muted">
                                Indica el nombre de la persona que recibirá el servicio en esta ubicación. 
                                Si está vacío, se asume que eres tú.
                            </small>
                        </div>

                        <!-- Etiqueta -->
                        <div class="mb-3">
                            <label for="label" class="form-label fw-bold">
                                <i class="fas fa-tag"></i> Etiqueta (Ej: Casa, Oficina, etc.)
                            </label>
                            <input type="text" name="label" id="label" class="form-control" 
                                   placeholder="Casa, Oficina, Casa de padres..." required>
                            <small class="text-muted">Esto te ayudará a identificar la ubicación</small>
                        </div>

                        <!-- Dirección -->
                        <div class="mb-3">
                            <label for="address" class="form-label fw-bold">
                                <i class="fas fa-map-pin"></i> Dirección
                            </label>
                            <input type="text" name="address" id="address" class="form-control" 
                                   placeholder="Ej: Calle Principal 123, Apto 4B" required>
                        </div>

                        <!-- Referencia -->
                        <div class="mb-3">
                            <label for="reference" class="form-label fw-bold">
                                <i class="fas fa-comment"></i> Referencia (Opcional)
                            </label>
                            <input type="text" name="reference" id="reference" class="form-control" 
                                   placeholder="Ej: Cerca del parque, al lado del supermercado...">
                            <small class="text-muted">Información adicional para que el proveedor encuentre fácilmente</small>
                        </div>

                        <!-- Mapa -->
                        <div class="mb-3">
                            <label for="map" class="form-label fw-bold">
                                <i class="fas fa-map"></i> Selecciona en el Mapa
                            </label>
                            <p class="text-muted small">
                                Haz clic en el mapa para seleccionar tu ubicación exacta
                            </p>
                            <div id="map" style="height: 400px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 10px;"></div>
                        </div>

                        <!-- Coordenadas (Oculto) -->
                        <input type="hidden" name="latitude" id="latitude" required>
                        <input type="hidden" name="longitude" id="longitude" required>

                        <!-- Botones -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <i class="fas fa-check"></i> Guardar Ubicación
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Leaflet Map -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<script>
let map;
let marker;

// Inicializar mapa
function initMap() {
    // Ubicación por defecto (Quito, Ecuador)
    const defaultLat = -0.2226;
    const defaultLng = -78.5129;
    
    map = L.map('map').setView([defaultLat, defaultLng], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 19,
    }).addTo(map);
    
    // Click en el mapa para agregar marcador
    map.on('click', function(e) {
        setMarker(e.latlng.lat, e.latlng.lng);
    });
}

function setMarker(lat, lng) {
    // Remover marcador anterior
    if (marker) {
        map.removeLayer(marker);
    }
    
    // Crear nuevo marcador
    marker = L.marker([lat, lng], {
        draggable: true
    }).addTo(map);
    
    // Actualizar campos
    document.getElementById('latitude').value = lat.toFixed(6);
    document.getElementById('longitude').value = lng.toFixed(6);
    
    // Permitir mover el marcador
    marker.on('dragend', function() {
        const position = marker.getLatLng();
        document.getElementById('latitude').value = position.lat.toFixed(6);
        document.getElementById('longitude').value = position.lng.toFixed(6);
    });
    
    // Zoom al marcador
    map.setView([lat, lng], 15);
}

// Validar formulario
document.getElementById('locationForm').addEventListener('submit', function(e) {
    if (!document.getElementById('latitude').value || !document.getElementById('longitude').value) {
        e.preventDefault();
        alert('Por favor selecciona una ubicación en el mapa');
        return false;
    }
});

// Inicializar al cargar
document.addEventListener('DOMContentLoaded', initMap);
</script>
{% endblock %}