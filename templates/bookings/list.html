{% extends 'base.html' %}

{% block title %}Mis Reservas - Liberi{% endblock %}

{% block content %}
<div class="container mt-4 mb-5">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2>
                        <i class="fas fa-calendar-check"></i> 
                        {% if user.profile.role == 'provider' %}
                            Mis Reservas Recibidas
                        {% else %}
                            Mis Reservas
                        {% endif %}
                    </h2>
                    <p class="text-muted mb-0">
                        {% if user.profile.role == 'provider' %}
                            Gestiona las reservas de tus clientes
                        {% else %}
                            Gestiona todas tus reservas de servicios
                        {% endif %}
                    </p>
                </div>
                {% if user.profile.role == 'customer' %}
                <a href="{% url 'services_list' %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Nueva Reserva
                </a>
                {% else %}
                <a href="{% url 'dashboard' %}" class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left"></i> Volver al Dashboard
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Stats -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center border-primary">
                <div class="card-body">
                    <h3 class="text-primary mb-0">{{ bookings.count }}</h3>
                    <small class="text-muted">Total</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-warning">
                <div class="card-body">
                    <h3 class="text-warning mb-0">{{ pending_count }}</h3>
                    <small class="text-muted">Pendientes</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-info">
                <div class="card-body">
                    <h3 class="text-info mb-0">{{ accepted_count }}</h3>
                    <small class="text-muted">Aceptadas</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-success">
                <div class="card-body">
                    <h3 class="text-success mb-0">{{ completed_count }}</h3>
                    <small class="text-muted">Completadas</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-4" id="bookingsTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button">
                Todas ({{ bookings.count }})
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button">
                Pendientes ({{ pending_count }})
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="accepted-tab" data-bs-toggle="tab" data-bs-target="#accepted" type="button">
                Aceptadas ({{ accepted_count }})
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completed" type="button">
                Completadas ({{ completed_count }})
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="bookingsTabContent">
        <!-- Tab: Todas -->
        <div class="tab-pane fade show active" id="all" role="tabpanel">
            {% if bookings %}
                {% for booking in bookings %}
                <div class="card mb-3 {% if booking.is_past and booking.status != 'completed' %}border-warning{% elif booking.is_past %}bg-light{% endif %}">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div class="flex-grow-1">
                                        <h5 class="mb-2">Reserva #{{ booking.booking_id }}</h5>
                                        
                                        <!-- Fechas en formato mejorado -->
                                        <div class="row g-2 mb-2">
                                            <div class="col-md-6">
                                                <div class="d-flex align-items-center">
                                                    <div class="bg-primary bg-opacity-10 rounded p-2 me-2" style="min-width: 40px; text-align: center;">
                                                        <i class="fas fa-calendar-check text-primary"></i>
                                                    </div>
                                                    <div>
                                                        <small class="text-muted d-block" style="font-size: 0.75rem;">Cita agendada para:</small>
                                                        <strong class="text-primary">{{ booking.scheduled_time|date:"D d/m/Y" }}</strong>
                                                        <br>
                                                        <strong class="text-primary">{{ booking.scheduled_time|date:"H:i" }}</strong>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="d-flex align-items-center">
                                                    <div class="bg-secondary bg-opacity-10 rounded p-2 me-2" style="min-width: 40px; text-align: center;">
                                                        <i class="fas fa-clock text-secondary"></i>
                                                    </div>
                                                    <div>
                                                        <small class="text-muted d-block" style="font-size: 0.75rem;">Reserva creada:</small>
                                                        <span class="text-secondary">{{ booking.created_at|date:"d/m/Y" }}</span>
                                                        <br>
                                                        <span class="text-secondary">{{ booking.created_at|date:"H:i" }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Contador de tiempo -->
                                        {% if not booking.is_past and booking.status == 'accepted' and booking.payment_status == 'paid' %}
                                            {% if booking.hours_until <= 24 %}
                                                <div class="alert alert-warning py-1 px-2 mb-2">
                                                    <i class="fas fa-bell"></i> 
                                                    <strong>¡Faltan {{ booking.hours_until }} hora{{ booking.hours_until|pluralize }} para la cita!</strong>
                                                </div>
                                            {% elif booking.days_until <= 7 %}
                                                <div class="alert alert-info py-1 px-2 mb-2">
                                                    <i class="fas fa-calendar-day"></i> 
                                                    <strong>Faltan {{ booking.days_until }} día{{ booking.days_until|pluralize }} para la cita</strong>
                                                </div>
                                            {% endif %}
                                        {% elif booking.is_past and booking.status != 'completed' %}
                                            <div class="alert alert-danger py-1 px-2 mb-2">
                                                <i class="fas fa-exclamation-triangle"></i> 
                                                <strong>¡Atención! Esta reserva pasó y no está completada</strong>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="text-end">
                                        <span class="badge bg-{% if booking.status == 'pending' %}warning{% elif booking.status == 'accepted' %}info{% elif booking.status == 'completed' %}success{% elif booking.status == 'cancelled' %}danger{% else %}secondary{% endif %} fs-6">
                                            {{ booking.get_status_display }}
                                        </span>
                                        {% if booking.payment_status == 'paid' %}
                                        <span class="badge bg-success fs-6 mt-1 d-block">
                                            <i class="fas fa-check-circle"></i> Pagado
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>

                                <hr class="my-2">

                                <!-- Info según el rol -->
                                {% if booking.provider == user %}
                                    <p class="mb-1"><strong>Cliente:</strong> {{ booking.customer.get_full_name }}</p>
                                    <p class="mb-1"><strong>Teléfono:</strong> {{ booking.customer.profile.phone }}</p>
                                {% else %}
                                    <p class="mb-1">
                                        <strong>Proveedor:</strong> 
                                        {% if booking.provider.provider_profile.business_name %}
                                            <strong>{{ booking.provider.provider_profile.business_name }}</strong>
                                            <br><small>{{ booking.provider.get_full_name }}</small>
                                        {% else %}
                                            {{ booking.provider.get_full_name }}
                                        {% endif %}
                                    </p>
                                    <p class="mb-1"><strong>Teléfono:</strong> {{ booking.provider.profile.phone }}</p>
                                {% endif %}

                                <p class="mb-1">
                                    <strong>Servicios:</strong>
                                    {% for service in booking.service_list %}
                                        {{ service.name }}{% if not forloop.last %}, {% endif %}
                                    {% endfor %}
                                </p>

                                {% if booking.location %}
                                <p class="mb-1">
                                    <strong>Ubicación:</strong> {{ booking.location.address|truncatewords:15 }}
                                </p>
                                {% endif %}

                                {% if booking.notes %}
                                <p class="mb-1">
                                    <strong>Notas:</strong> {{ booking.notes }}
                                </p>
                                {% endif %}
                            </div>

                            <div class="col-md-4 text-end">
                                <h4 class="text-primary mb-3">${{ booking.total_cost }}</h4>
                                
                                <div class="mb-2">
                                    <span class="badge bg-{% if booking.payment_status == 'paid' %}success{% elif booking.payment_status == 'pending' %}warning{% else %}secondary{% endif %}">
                                        <i class="fas fa-credit-card"></i> {{ booking.get_payment_status_display }}
                                    </span>
                                </div>

                                <div class="d-grid gap-2">
                                    <a href="{% url 'booking_detail' booking.id %}" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-eye"></i> Ver Detalles
                                    </a>

                                    <!-- Acciones según rol y estado -->
                                    {% if booking.provider == user %}
                                        <!-- Acciones del PROVEEDOR (quien da el servicio) -->
                                        {% if booking.status == 'pending' %}
                                            <form method="post" action="{% url 'booking_accept' booking.id %}" class="d-inline">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-success btn-sm w-100">
                                                    <i class="fas fa-check"></i> Aceptar
                                                </button>
                                            </form>
                                            <form method="post" action="{% url 'booking_reject' booking.id %}" class="d-inline">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-danger btn-sm w-100" 
                                                        onclick="return confirm('¿Estás seguro de rechazar esta reserva?')">
                                                    <i class="fas fa-times"></i> Rechazar
                                                </button>
                                            </form>
                                        {% elif booking.status == 'accepted' and not booking.is_past %}
                                            <form method="post" action="{% url 'booking_complete' booking.id %}" class="d-inline">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-success btn-sm w-100">
                                                    <i class="fas fa-check-circle"></i> Completar
                                                </button>
                                            </form>
                                        {% elif booking.is_past and booking.status != 'completed' %}
                                            <form method="post" action="{% url 'booking_complete' booking.id %}" class="d-inline">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-warning btn-sm w-100">
                                                    <i class="fas fa-exclamation-triangle"></i> Completar Ahora
                                                </button>
                                            </form>
                                        {% endif %}
                                    {% else %}
                                        <!-- Acciones del CLIENTE (quien recibe el servicio) -->
                                        {% if booking.status == 'completed' %}
                                            <a href="{% url 'review_create' booking.id %}" class="btn btn-warning btn-sm">
                                                <i class="fas fa-star"></i> Dejar Reseña
                                            </a>
                                        {% endif %}

                                        {% if booking.payment_status == 'pending' and booking.status == 'accepted' %}
                                            <a href="{% url 'payment_process' booking.id %}" class="btn btn-primary btn-sm">
                                                <i class="fas fa-credit-card"></i> Pagar Ahora
                                            </a>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-inbox fa-4x text-muted mb-4"></i>
                        <h4>No hay reservas</h4>
                        <p class="text-muted mb-4">
                            {% if user.profile.role == 'provider' %}
                                Aún no has recibido reservas
                            {% else %}
                                Aún no tienes reservas
                            {% endif %}
                        </p>
                        {% if user.profile.role == 'customer' %}
                        <a href="{% url 'services_list' %}" class="btn btn-primary">
                            <i class="fas fa-search"></i> Buscar Servicios
                        </a>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Tab: Pendientes -->
        <div class="tab-pane fade" id="pending" role="tabpanel">
            {% if pending_bookings %}
                {% for booking in pending_bookings %}
                    {# Mismo contenido que arriba #}
                    <div class="card mb-3">
                        <div class="card-body">
                            <a href="{% url 'booking_detail' booking.id %}" class="text-decoration-none text-dark">
                                <h6>Reserva #{{ booking.booking_id }}</h6>
                                <p class="mb-1 text-muted"><small>{{ booking.scheduled_time|date:"d/m/Y H:i" }}</small></p>
                            </a>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="alert alert-info text-center">
                    <p class="mb-0">No hay reservas pendientes</p>
                </div>
            {% endif %}
        </div>

        <!-- Tab: Aceptadas -->
        <div class="tab-pane fade" id="accepted" role="tabpanel">
            {% if accepted_bookings %}
                {% for booking in accepted_bookings %}
                    <div class="card mb-3">
                        <div class="card-body">
                            <a href="{% url 'booking_detail' booking.id %}" class="text-decoration-none text-dark">
                                <h6>Reserva #{{ booking.booking_id }}</h6>
                                <p class="mb-1 text-muted"><small>{{ booking.scheduled_time|date:"d/m/Y H:i" }}</small></p>
                            </a>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="alert alert-info text-center">
                    <p class="mb-0">No hay reservas aceptadas</p>
                </div>
            {% endif %}
        </div>

        <!-- Tab: Completadas -->
        <div class="tab-pane fade" id="completed" role="tabpanel">
            {% if completed_bookings %}
                {% for booking in completed_bookings %}
                    <div class="card mb-3">
                        <div class="card-body">
                            <a href="{% url 'booking_detail' booking.id %}" class="text-decoration-none text-dark">
                                <h6>Reserva #{{ booking.booking_id }}</h6>
                                <p class="mb-1 text-muted"><small>{{ booking.scheduled_time|date:"d/m/Y H:i" }}</small></p>
                            </a>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="alert alert-info text-center">
                    <p class="mb-0">No hay reservas completadas</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.bg-opacity-10 {
    opacity: 0.1;
}

.bg-primary.bg-opacity-10 {
    background-color: rgba(13, 110, 253, 1);
}

.bg-secondary.bg-opacity-10 {
    background-color: rgba(108, 117, 125, 1);
}
</style>
{% endblock %}