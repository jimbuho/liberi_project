{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Liberi - Servicios a domicilio{% endblock %}</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="{% static 'images/liberi_favicon.svg' %}">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/liberi.css' %}?v=3.4">

    <!-- Meta Tags Dinámicos -->
    <meta property="og:type" content="{% block og_type %}website{% endblock %}">
    <meta property="og:url" content="{% block og_url %}{{ request.build_absolute_uri }}{% endblock %}">
    <meta property="og:title" content="{% block og_title %}Liberi{% endblock %}">
    <meta property="og:description" content="{% block og_description %}Servicios verificados{% endblock %}">
    {% block og_image %}
    <meta property="og:image" content="{% if meta_image %}{{ meta_image }}{% endif %}">{% endblock %}
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{% block twitter_title %}Liberi{% endblock %}">
    <meta name="twitter:image"
        content="{% block twitter_image %}{% if meta_image %}{{ meta_image }}{% endif %}{% endblock %}">

    <style>
        /* Loader Global */
        #globalLoader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(3px);
        }

        #globalLoader.active {
            display: flex;
        }

        .loader-content {
            text-align: center;
            color: white;
        }

        .loader-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loader-text {
            font-size: 18px;
            font-weight: 500;
        }

        /* Estilos para categorías compactas */
        .categories-grid-compact {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .category-card-compact {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 2px solid transparent;
        }

        .category-card-compact:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            border-color: #5DADE2;
        }

        .category-icon-compact {
            font-size: 2.5rem;
            display: block;
            margin-bottom: 10px;
        }

        .category-name-compact {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .category-description-compact {
            font-size: 0.85rem;
            color: #7f8c8d;
            margin-bottom: 15px;
            min-height: 60px;
        }

        .btn-category-compact {
            display: inline-block;
            padding: 8px 16px;
            background: linear-gradient(135deg, #5DADE2 0%, #48C9B0 100%);
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-category-compact:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(93, 173, 226, 0.4);
            color: white;
        }

        @media (max-width: 768px) {
            .categories-grid-compact {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
            }

            .category-icon-compact {
                font-size: 2rem;
            }

            .category-name-compact {
                font-size: 1rem;
            }

            .category-description-compact {
                font-size: 0.8rem;
                min-height: 50px;
            }
        }
    </style>

    {% block extra_css %}{% endblock %}
</head>

<body>
    <!-- Loader Global -->
    <div id="globalLoader">
        <div class="loader-content">
            <div class="loader-spinner"></div>
            <div class="loader-text">Procesando...</div>
        </div>
    </div>

    <!-- Navbar CORREGIDO -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="{% url 'home' %}">
                <img src="{% static 'images/logo-liberi.png' %}" alt="Liberi" style="height: 40px;">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'services_list' %}">
                            <i class="fas fa-th"></i> Servicios
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'providers_list' %}">
                            <i class="fas fa-users"></i> Proveedores
                        </a>
                    </li>
                    {% if user.is_authenticated %}
                    <!-- NOTIFICACIONES - DROPDOWN CORREGIDO -->
                    <li class="nav-item dropdown">
                        <a class="nav-link position-relative" href="#" id="notificationsDropdown" role="button"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-bell"></i>
                            <span id="notificationCount"
                                class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                                style="display: none;">
                                0
                            </span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end shadow-sm" aria-labelledby="notificationsDropdown"
                            style="min-width: 350px; max-height: 500px; overflow-y: auto;">
                            <li class="dropdown-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <strong>Notificaciones</strong>
                                    <a href="#" id="markAllRead" class="text-decoration-none small"
                                        style="display: none;">
                                        <i class="fas fa-check-double"></i> Marcar todo como leído
                                    </a>
                                </div>
                            </li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li id="notificationsList">
                                <div class="text-center py-4 text-muted">
                                    <i class="fas fa-spinner fa-spin me-2"></i>Cargando...
                                </div>
                            </li>
                        </ul>
                    </li>

                    <!-- USUARIO - DROPDOWN EXISTENTE -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user"></i> {{ user.first_name|default:user.username }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            {% if user.provider_profile and user.provider_profile.status != 'approved' %}
                            <!-- Proveedor con perfil incompleto -->
                            <li>
                                <a class="dropdown-item disabled" href="#">
                                    <i class="fas fa-hourglass-half text-warning"></i> Perfil en Proceso
                                </a>
                            </li>
                            <li>
                                <small class="dropdown-item-text text-muted px-3">
                                    Completa tu perfil para acceder al dashboard
                                </small>
                            </li>
                            {% else %}
                            <!-- Usuario normal o proveedor aprobado -->
                            <li>
                                <a class="dropdown-item" href="{% url 'dashboard' %}">
                                    <i class="fas fa-tachometer-alt"></i> Dashboard
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'bookings_list' %}">
                                    <i class="fas fa-calendar-check"></i> Mis Reservas
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'change_password' %}">
                                    <i class="fas fa-lock"></i> Cambiar Contraseña
                                </a>
                            </li>
                            {% endif %}
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'logout' %}">
                                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                                </a>
                            </li>
                        </ul>
                    </li>
                    {% else %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'login' %}">Iniciar Sesión</a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- Messages -->
    {% if messages %}
    <div class="container mt-3">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Content -->
    {% block content %}{% endblock %}

    <!-- Footer -->
    <footer class="bg-dark text-white mt-5 py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5><i class="fas fa-home"></i> Liberi</h5>
                    <p>Conectamos clientes con los mejores proveedores de servicios en Ecuador.</p>
                </div>
                <div class="col-md-4">
                    <h5>Enlaces</h5>
                    <ul class="list-unstyled">
                        <li><a href="{% url 'services_list' %}" class="text-white-50">Servicios</a></li>
                        <li><a href="{% url 'providers_list' %}" class="text-white-50">Proveedores</a></li>
                        <li><a href="{% url 'register_provider' %}" class="text-white-50">Ser Proveedor</a></li>
                        <li><a href="{% url 'legal:terms_user' %}" class="text-white-50">Términos de Uso</a></li>
                        <li><a href="{% url 'legal:privacy_user' %}" class="text-white-50">Política de Privacidad</a>
                        </li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h5>Contacto</h5>
                    <p class="text-white-50">
                        <i class="fas fa-envelope"></i> liberiservices@gmail.com<br>
                        <i class="fas fa-phone"></i> +593 95 884 0107
                    </p>
                </div>
            </div>
            <hr class="bg-light">
            <div class="text-center text-white-50">
                <p>&copy; 2025 Liberi Ecuador. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Loader Global Script -->
    <script>
        const loader = document.getElementById('globalLoader');

        // Mostrar loader en envío de formularios
        document.addEventListener('submit', function (e) {
            const form = e.target;
            // No mostrar loader en formularios GET (búsqueda/filtros) o con clase no-loader
            if (form.method.toLowerCase() === 'post' && !form.classList.contains('no-loader')) {
                loader.classList.add('active');
            }
        });

        // Mostrar loader en clics de botones y enlaces
        document.addEventListener('click', function (e) {
            // Buscar el elemento clickeado o su padre más cercano que sea un botón/enlace
            const target = e.target.closest('a, button');

            if (!target) return;

            // No mostrar loader si tiene la clase no-loader
            if (target.classList.contains('no-loader')) return;

            // No mostrar loader en enlaces de dropdown o navegación del navbar
            if (target.closest('.dropdown-menu') || target.closest('.navbar-nav')) return;

            // No mostrar loader en botones de cerrar (btn-close)
            if (target.classList.contains('btn-close')) return;

            // No mostrar loader en enlaces con # (modales, tabs, etc)
            if (target.tagName === 'A' && target.getAttribute('href') === '#') return;

            // No mostrar loader en enlaces con data-bs-toggle (Bootstrap components)
            if (target.hasAttribute('data-bs-toggle')) return;

            // MOSTRAR LOADER EN:

            // 1. Enlaces con clase btn (navegación a otra página)
            if (target.tagName === 'A' && target.classList.contains('btn')) {
                loader.classList.add('active');
                return;
            }

            // 2. Enlaces con clases específicas de acción
            if (target.tagName === 'A' && (
                target.classList.contains('btn-hero') ||
                target.classList.contains('btn-book') ||
                target.classList.contains('btn-category') ||
                target.classList.contains('btn-category-compact') ||
                target.classList.contains('btn-search'))) {
                loader.classList.add('active');
                return;
            }

            // 3. Botones que NO son type="submit" con clases específicas
            // (para acciones AJAX u otras que no sean submit de formulario)
            if (target.tagName === 'BUTTON' && target.type !== 'submit' &&
                (target.classList.contains('ajax-action') ||
                    target.classList.contains('load-action'))) {
                loader.classList.add('active');
                return;
            }

            // NOTA: Los botones type="submit" NO muestran loader aquí
            // El loader se mostrará cuando el evento 'submit' se dispare (arriba)
            // Esto garantiza que solo se muestre si la validación es exitosa
        });

        // Ocultar loader cuando la página se carga completamente
        window.addEventListener('load', function () {
            loader.classList.remove('active');
        });

        // Ocultar loader si hay error o la página se recarga
        window.addEventListener('pageshow', function () {
            loader.classList.remove('active');
        });

        // Ocultar loader después de 8 segundos como fallback
        let loaderTimeout;
        const observer = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
                if (mutation.target.classList.contains('active')) {
                    clearTimeout(loaderTimeout);
                    loaderTimeout = setTimeout(function () {
                        loader.classList.remove('active');
                    }, 8000);
                }
            });
        });
        observer.observe(loader, { attributes: true, attributeFilter: ['class'] });
    </script>

    {% if user.is_authenticated %}
    <!-- Notificaciones Script CORREGIDO -->
    <script>
        // Variables globales
        let notificationsDropdown = null;

        // Esperar a que el DOM esté listo
        document.addEventListener('DOMContentLoaded', function () {
            notificationsDropdown = document.getElementById('notificationsDropdown');

            if (!notificationsDropdown) {
                console.warn('Elemento #notificationsDropdown no encontrado');
                return;
            }

            // Cargar notificaciones cuando se abre el dropdown
            notificationsDropdown.addEventListener('click', function (e) {
                e.preventDefault();
                loadNotifications();
            });

            // Cargar contador inicial
            loadNotificationsCount();

            // Cargar notificaciones cada 30 segundos
            setInterval(loadNotificationsCount, 30000);

            // Marcar todo como leído - setup
            const markAllReadBtn = document.getElementById('markAllRead');
            if (markAllReadBtn) {
                markAllReadBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();

                    fetch('/api/notifications/mark-all-read/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                            'Content-Type': 'application/json'
                        }
                    }).then(() => {
                        loadNotifications();
                    }).catch(error => {
                        console.error('Error marking all as read:', error);
                    });
                });
            }
        });

        function loadNotifications() {
            fetch('/api/notifications/')
                .then(response => {
                    if (!response.ok) throw new Error('Error en response');
                    return response.json();
                })
                .then(data => {
                    updateNotificationsList(data.notifications);
                    const unreadCount = data.notifications.filter(n => !n.is_read).length;
                    updateNotificationCount(unreadCount);
                })
                .catch(error => {
                    console.error('Error loading notifications:', error);
                    document.getElementById('notificationsList').innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                            <p class="text-muted mb-0">Error al cargar notificaciones</p>
                        </div>
                    `;
                });
        }

        function loadNotificationsCount() {
            fetch('/api/notifications/count/')
                .then(response => {
                    if (!response.ok) throw new Error('Error en response');
                    return response.json();
                })
                .then(data => {
                    updateNotificationCount(data.count);
                })
                .catch(error => {
                    console.error('Error loading notification count:', error);
                });
        }

        function updateNotificationsList(notifications) {
            const container = document.getElementById('notificationsList');

            if (!notifications || notifications.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-bell-slash fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">No tienes notificaciones</p>
                    </div>
                `;
                document.getElementById('markAllRead').style.display = 'none';
                return;
            }

            let html = '';
            let hasUnread = false;

            notifications.forEach(notif => {
                const unreadClass = notif.is_read ? '' : 'bg-light';
                const unreadIcon = notif.is_read ? '' : '<span class="badge bg-primary me-2">Nueva</span>';

                if (!notif.is_read) hasUnread = true;

                html += `
                    <li>
                        <a href="#" class="dropdown-item py-2 ${unreadClass}" 
                           onclick="handleNotificationClick(event, ${notif.id}, '${notif.action_url || ''}')">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <strong class="d-block">${unreadIcon}${notif.title}</strong>
                                    <small class="text-muted d-block">${notif.message}</small>
                                    <small class="text-muted">${notif.created_at || ''}</small>
                                </div>
                            </div>
                        </a>
                    </li>
                `;
            });

            container.innerHTML = html;
            document.getElementById('markAllRead').style.display = hasUnread ? 'inline-block' : 'none';
        }

        function updateNotificationCount(count) {
            const badge = document.getElementById('notificationCount');
            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }

        function handleNotificationClick(event, notificationId, actionUrl) {
            event.preventDefault();

            fetch(`/api/notifications/${notificationId}/mark-read/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            }).then(() => {
                if (actionUrl && actionUrl !== '' && actionUrl !== 'None' && actionUrl !== '#') {
                    window.location.href = actionUrl;
                } else {
                    loadNotifications();
                }
            }).catch(error => {
                console.error('Error marking notification as read:', error);
                loadNotifications();
            });
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
    {% endif %}

    <!-- WhatsApp Floating Button -->
    <a href="https://wa.me/593958840107?text=Hola%20Liberi,%20necesito%20ayuda%20con..." class="whatsapp-float"
        target="_blank" rel="noopener noreferrer">
        <i class="fab fa-whatsapp my-float"></i>
    </a>

    {% block extra_js %}{% endblock %}
</body>

</html>